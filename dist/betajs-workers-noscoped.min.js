/*!
betajs-workers - v0.0.6 - 2017-01-15
Copyright (c) Oliver Friedmann
Apache-2.0 Software License.
*/
(function(){var Scoped=this.subScope();Scoped.binding("module","global:BetaJS.Workers"),Scoped.binding("base","global:BetaJS"),Scoped.define("module:",function(){return{guid:"9f1e96ea-528c-4110-83f8-76fa9a8900d3",version:"0.0.6"}}),Scoped.assumeVersion("base:version","~1.0.96"),Scoped.define("module:Client.TimerAugment",["module:Common.WorkerAugment","base:Functions","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(d){a.constructor.call(this,d);this.__id=0,this.__names=[],this.__callbacks={},c.iter(this.send,function(a,c){Scoped.getGlobal(c)||(Scoped.setGlobal(c,b.as_method(a,this)),this.__names.push(c))},this)},send:{setTimeout:function(a,b){return this.__id++,this.__callbacks[this.__id]=a,this.augmentCall("setTimeout",this.__id,b),this.__id},setInterval:function(a,b){return this.__id++,this.__callbacks[this.__id]=a,this.augmentCall("setTimeout",this.__id,b),this.__id},clearTimeout:function(a){this.augmentCall("clearTimeout",a),delete this.__callbacks[a]},clearInterval:function(a){this.augmentCall("clearInterval",a),delete this.__callbacks[a]}},destroy:function(){c.iter(this.__names,function(a){Scoped.setGlobal(a,null)}),a.destroy.call(this)},intf:{timeoutCallback:function(a){this.__callbacks[a]&&(this.__callbacks[a].call(this),delete this.__callbacks[a])},intervalCallback:function(a){this.__callbacks[a]&&this.__callbacks[a].call(this)}}}}).register("client:timer")}),Scoped.define("module:Client.LocalStorageAugment",["module:Common.WorkerAugment","base:Promise","base:Objs","base:Functions"],function(a,b,c,d,e){return a.extend({scoped:e},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__id=0,this.__callbacks={},Scoped.getGlobal("localStorage")||Scoped.setGlobal("localStorage",c.map(this.send,function(a){return d.as_method(a,this)},this))},send:{getItem:function(a){return this.__id++,this.__callbacks[this.__id]=b.create(),this.augmentCall("localStorageGetItem",a,this.__id),this.__callbacks[this.__id]},setItem:function(a,b){this.augmentCall("localStorageSetItem",a,b)},removeItem:function(a){this.augmentCall("localStorageRemoveItem",a)}},intf:{localStorageGetItemCallback:function(a,b){this.__callbacks[b]&&(this.__callbacks[b].asyncSuccess(a),delete this.__callbacks[b])}}}}).register("client:localStorage")}),Scoped.define("module:Common.AugmentedWorker",["base:Class","base:Events.EventsMixin","base:Objs"],function(a,b,c,d){return a.extend({scoped:d},[b,function(a){return{constructor:function(b,d){a.constructor.call(this),this.__worker=b,this.__augments={},this.__handlers={},this.__receive={},d.forEach(function(a){var b=this.auto_destroy(new this.cls.augments[a](this));this.__augments[a]=b,c.iter(b.intf,function(a,c){this.__receive[c]=b},this)},this);var e=this;this.__worker.addEventListener("message",function(a){a.data.augment?e._receiveAugment(a.data.augment.message,a.data.augment.data):a.data.data&&e._receiveMessage(a.data)}),this.__worker.addEventListener("error",function(a){e._receiveError(a)})},worker:function(){return this.__worker},postMessage:function(a,b){return this.__worker.postMessage({data:a},b),this},addEventListener:function(a,b){return this.on(a,b),this},augmentCall:function(a,b){this.__worker.postMessage({augment:{message:a,data:b}})},_receiveAugment:function(a,b){var c=this.__receive[a];c&&c.intf[a].apply(c,b)},_receiveMessage:function(a){this.trigger("message",a),this.onmessage&&this.onmessage(a)},_receiveError:function(a){this.trigger("error",a),this.onerror&&this.onerror(a)}}}],{augments:{}})}),Scoped.define("module:Common.WorkerAugment",["base:Class","base:Functions","module:Common.AugmentedWorker"],function(a,b,c,d){return a.extend({scoped:d},function(a){return{constructor:function(b){a.constructor.call(this),this.__parent=b},intf:{},parent:function(){return this.__parent},augmentCall:function(a){this.__parent.augmentCall(a,b.getArguments(arguments,1))}}},{register:function(a){return c.augments[a]=this,this}})}),Scoped.define("module:Common.WorkerSenderChannel",["base:Channels.Sender","base:Objs"],function(a,b,c){return a.extend({scoped:c},function(a){return{constructor:function(b){a.constructor.call(this),this.__worker=b||self},_send:function(a,c,d){var e=[];d&&b.iter(d,function(a,b){a&&a.transfer&&c.data[b]&&e.push(c[b])},this),this.__worker.postMessage({message:a,data:c},e)}}})}),Scoped.define("module:Common.WorkerReceiverChannel",["base:Channels.Receiver"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this),this.__worker=b||self;var c=this;this.__worker.addEventListener("message",function(a){c._receive(a.data.message,a.data.data)})}}})}),Scoped.define("module:Host.TimerAugment",["module:Common.WorkerAugment"],function(a,b){return a.extend({scoped:b},function(a){return{constructor:function(b){a.constructor.call(this,b),this.__timeouts={},this.__intervals={}},destroy:function(){Objs.iter(this.__timeouts,function(a){clearTimeout(a)}),Objs.iter(this.__timeouts,function(a){clearTimeout(a)}),a.destroy.call(this)},intf:{setTimeout:function(a,b){var c=this;this.__timeouts[a]=setTimeout(function(){c.augmentCall("timeoutCallback",a),delete c.__timeouts[a]},b)},setInterval:function(a,b){var c=this;this.__intervals[b]=setInterval(function(){c.augmentCall("intervalCallback",b)},a)},clearTimeout:function(a){a in this.__timeouts&&(clearTimeout(this.__timeouts[a]),delete this.__timeouts[a])},clearInterval:function(a){a in this.__intervals&&(clearInterval(this.__intervals[a]),delete this.__intervals[a])}}}}).register("host:timer")}),Scoped.define("module:Host.LocalStorageAugment",["module:Common.WorkerAugment"],function(a,b){return a.extend({scoped:b},function(a){return{intf:{localStorageGetItem:function(a,b){this.augmentCall("localStorageGetItemCallback",localStorage.getItem(a),b)},localStorageSetItem:function(a,b){localStorage.setItem(a,b)},localStorageRemoveItem:function(a){localStorage.removeItem(a)}}}}).register("host:localStorage")}),Scoped.define("module:Host.PseudoWorker",["base:Class","base:Events.EventsMixin","base:Functions","module:Common.AugmentedWorker"],function(a,b,c,d,e){return a.extend({scoped:e},[b,{bind:function(a){return this.__peer=a,this},postMessage:function(a,b){this.__peer.triggerAsync("message",a)},addEventListener:function(a,b){return"message"===a?this.on(a,function(a){b.call(this,{data:a})},this):this.on(a,b),this}}],{createWorker:function(a,b){try{var c=new Worker(a);if(b&&b.length>0)return new d(c,b)}catch(e){return null}},createPseudoWorker:function(a,b){var c=new this,d=c.auto_destroy(new this);return c.bind(d),d.bind(c),a.call(b||this,d),c},createAsFallback:function(){var a=c.matchArgs(arguments,{url:!0,augments:"array",workerFactory:!0,workerFactoryCtx:"object"});return this.createWorker(a.url,a.augments)||this.createPseudoWorker(a.workerFactory,a.workerFactoryCtx)}})})}).call(Scoped);